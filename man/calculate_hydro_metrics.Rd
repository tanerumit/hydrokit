% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/hydro_metrics.R
\name{calculate_hydro_metrics}
\alias{calculate_hydro_metrics}
\title{Calculate Hydrological Metrics from Daily Discharge}
\usage{
calculate_hydro_metrics(
  Q,
  date,
  high_thresh_quantile = 0.9,
  low_thresh_quantile = 0.1,
  threshold_scope = c("global", "annual", "seasonal", "baseline"),
  baseline_years = NULL,
  baseline_dates = NULL,
  min_finite_thresholds = 10L,
  zero_thr_mode = c("absolute", "quantile", "fraction_median"),
  zero_thr = 0.02,
  zero_q = 0.02,
  zero_frac_median = 0.001,
  roc_eps = 0,
  roc_smooth_k = 1L,
  month_min_frac = 0,
  report_coverage = FALSE,
  metric_set = "erfa70",
  metrics = NULL,
  purpose = NULL,
  summaries = c("med", "iqr"),
  return_annual = FALSE
)
}
\arguments{
\item{Q}{Numeric vector (single site) or matrix/data.frame (multi-site) of daily
discharge values. For multi-site inputs, columns are sites and optional column
names are used as site identifiers.}

\item{date}{Date vector corresponding to rows of \code{Q}.}

\item{high_thresh_quantile}{Numeric scalar in \code{[0,1]} for the high-flow
pulse threshold quantile.}

\item{low_thresh_quantile}{Numeric scalar in \code{[0,1]} for the low-flow
pulse threshold quantile.}

\item{threshold_scope}{Character scalar, one of "global", "annual", "seasonal",
"baseline". Controls how thresholds are estimated for high/low pulses and
zero-flow sequences.}

\item{baseline_years}{Optional integer vector of years used when
\code{threshold_scope = "baseline"}.}

\item{baseline_dates}{Optional length-2 Date vector \code{c(start, end)} used when
\code{threshold_scope = "baseline"} (inclusive bounds).}

\item{min_finite_thresholds}{Integer scalar >= 1. Minimum number of finite values
required to estimate thresholds within each subset.}

\item{zero_thr_mode}{Character scalar, one of "absolute", "quantile",
"fraction_median".}

\item{zero_thr}{Numeric scalar used when \code{zero_thr_mode = "absolute"}.}

\item{zero_q}{Numeric scalar in \code{[0,1]} used when \code{zero_thr_mode = "quantile"}.}

\item{zero_frac_median}{Numeric scalar >= 0 used when \code{zero_thr_mode =
"fraction_median"}; multiplied by the subset median discharge.}

\item{roc_eps}{Numeric scalar >= 0. Deadband for rise/fall classification; daily
changes with absolute magnitude \code{<= roc_eps} are ignored.}

\item{roc_smooth_k}{Integer scalar >= 1. Centered moving-average window (days)
applied before rate-of-change calculations; \code{1} disables smoothing.}

\item{month_min_frac}{Numeric scalar in \code{[0,1]}. Minimum fraction of calendar
days in a month that must have finite discharge values to compute that monthly
mean; otherwise NA. Default 0 disables completeness filtering.}

\item{report_coverage}{Logical. If TRUE, compute monthly coverage fractions for
internal context (not returned).}

\item{metric_set}{Character scalar. Name of a registered metric set (default
"erfa70"). Use \code{NULL} to select metrics via \code{purpose}.}

\item{metrics}{Optional character vector of base metric keys to compute; overrides
\code{metric_set} and \code{purpose}.}

\item{purpose}{Optional character scalar. Selects all metrics tagged for a purpose
(used only when \code{metrics} and \code{metric_set} are NULL).}

\item{summaries}{Character vector of summary stat names (e.g., \code{c("med","iqr")})
or a named list of summary functions.}

\item{return_annual}{Logical. If TRUE, also returns the annual base metric table.}
}
\value{
A tibble with columns:
\itemize{
\item \code{metric_id}: legacy ERFA metric id (1..70) when applicable; otherwise NA
\item \code{metric_key}: base metric key (stable join key)
\item \code{group}: metric group
\item \code{stat}: summary statistic label (e.g., "med", "iqr")
\item \code{metric}: legacy-style name (e.g., "amax1d_m", "amax1d_v")
\item \code{value}: summarized metric value
}
For multi-site input, includes \code{site}. If \code{return_annual = TRUE}, returns
a list with elements \code{summary} and \code{annual}. The annual table includes
\code{year}, \code{metric_key}, and \code{value} (plus \code{site} for multi-site).
}
\description{
Calculates registry-defined hydrological metrics from daily discharge and summarizes
annual values across years for one or more sites.
}
\details{
Inputs must represent daily values: \code{date} must be strictly increasing and
unique, and its length must match rows of \code{Q}. Gaps in \code{date} are allowed
but trigger a warning; rolling means and rise/fall counts assume regular daily
spacing and may be biased if gaps are present.

Thresholds for pulse and zero-flow metrics are estimated from either the entire
series ("global"), each year separately ("annual"), by month across years
("seasonal"), or from a baseline subset ("baseline"). Threshold estimation
requires at least \code{min_finite_thresholds} finite values; otherwise an error
is thrown. Zero-flow thresholds can be absolute, a quantile of the subset, or a
fraction of the subset median.

Metric selection uses \code{metrics} directly when provided; otherwise it uses
\code{metric_set} (default "erfa70"), or \code{purpose} when \code{metric_set = NULL}.
Annual values are summarized with the functions named in \code{summaries}; by
default median and IQR. ERFA \code{metric_id} values are populated only when the
full ERFA70 metric set and \code{c("med","iqr")} summaries are used.
}
\examples{
date <- seq.Date(as.Date("2001-01-01"), as.Date("2002-12-31"), by = "day")
Q <- 2 + sin(seq_along(date) * 2 * pi / 365)
out <- calculate_hydro_metrics(Q, date, metrics = c("amax1d", "amin1d"))
out

Q_multi <- cbind(site_a = Q, site_b = Q * 1.1)
out_multi <- calculate_hydro_metrics(Q_multi, date, metrics = c("amax1d", "amin1d"))
out_multi
}
